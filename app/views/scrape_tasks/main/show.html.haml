%div{ id: "scrapeTask", scrape_task_id: @scrape_task.id }

%hr/
#scrapeTaskName.text-center
  =link_to("##{@scrape_task.id} #{@scrape_task.name}", @scrape_task)
%hr.mb-0/

.d-flex.justify-content-between.align-items-center.small
  .text-secondary
    created by #{@scrape_task.creator.name}
  .text-secondary
    created at: #{@scrape_task.created_at}#{@scrape_task.updated_early? ? " | updated at: #{@scrape_task.updated_at}" : ""}

.row.align-items-stretch.mt-4.mb-4
  .col-xl-8.col-sm-12
    #scrappingInfo
      .card
        .card-header.p-1.small
          .d-flex.justify-content-between.align-items-center
            MAIN INFO
            #scrapeTaskStatusComment
              =render 'status_comment'
            .d-flex.align-items-center
              -if @permissions['progress_status'].values.any?
                #scrapeTaskStatus.d-inline-block
                  -if @permissions['progress_status']['edit_form']
                    =render 'statuses'
                  -elsif @permissions['progress_status']['show']
                    =@scrape_task.status.name
              -if @permissions['edit_form']
                #editScrapeTask
                  %button{ onclick: 'loadEditForm();', type: 'button', class: 'p-0 btn btn-sm btn-link', 'data-toggle' => "modal", 'data-target' => "#scrapeTaskEdit" }
                    [ edit ]
                  :javascript
                    function loadEditForm() {
                      Rails.ajax({
                        type: "GET",
                        dataType: 'script',
                        url: `#{edit_scrape_task_path(@scrape_task)}`
                      })
                    }

        .card-body
          =render 'scrape_task_info'
  .col-xl-4.col-sm-12.pl-xl-0
    .card.h-100
      .card-header.p-1.small
        CONVERSATION
      .card-body

-if @permissions['edit_form']
  #scrapeTaskEdit.modal.fade{ 'data-keyboard' => "false", "aria-hidden" => "true",
                      "aria-labelledby" => "scrapeTaskEdit", tabindex: "-1" }
    .modal-dialog.modal-dialog-centered.modal-xl
      .modal-content
        .modal-header
        .modal-body.small
          .text-center
            .spinner-border.small{ style: "width: 3rem; height: 3rem;" }
              %span.sr-only
        .modal-footer

-if @permissions['edit_form']
  #updateScrapeTaskModal.modal.fade.pr-0{ "aria-hidden" => "true", "aria-labelledby" => "updateScrapeTaskModal",
                                           'data-backdrop' => 'static', "data-keyboard" => "false" }
    .modal-dialog.modal-dialog-scrollable.modal-lg
      .modal-content
        .modal-header
          UPDATE SCRAPE TASK
          %button.close{ "aria-label" => "Close", "data-dismiss" => "modal", type: "button" }
            %span{ "aria-hidden" => "true" } Ã—
        .modal-body.small
          =render 'edit'
        .modal-footer.justify-content-center
          =link_to('UPDATE', '#', id: 'updateScrapeTaskButton', class: 'btn btn-sm btn-dark')
          .btn.btn-sm.btn-outline-secondary{ "aria-label" => "Close", "data-dismiss" => "modal", type: "button" }
            CANCEL

  :javascript
    document.querySelector('#updateScrapeTaskButton').addEventListener('click', (event) => {
      event.preventDefault();
      document.querySelector('#hiddenUpdateScrapeTaskButton').click();
    }, false);

#scrapeInstructionAnchor
#scrapeEvaluationDocAnchor

%ul#scrapeTaskTabs.nav.nav-tabs.small
  %li.nav-item.text-center{ style: 'width: 50%' }
    %a#scrapeInstructionTab.nav-link.active{"aria-selected" => "true", "data-toggle" => "tab", :href => "#scrapeInstruction", :role => "tab"} Instruction
  %li.nav-item.text-center{ style: 'width: 50%' }
    %a#scrapeEvaluationDocTab.nav-link{"aria-selected" => "false", "data-toggle" => "tab", :href => "#scrapeEvaluationDoc", :role => "tab"} Evaluation Document

#scrapeTaskTabsContent.tab-content
  #scrapeInstruction.tab-pane.fade.show.active
    .card.border-top-0.rounded-top-0.mb-5
      #scrapeInstructionEdit.small
        .row
          .col-8.offset-2.p-0
            %hr.mb-0.mt-3/
            =button_to('[ edit ]', edit_scrape_task_instruction_path(@scrape_task), class: 'btn btn-sm btn-link', method: :get, remote: true, data: { disable_with: '...'})
            %hr.mt-0/
      #instruction.show{"data-parent" => "#scrapeInstruction"}
        =render 'scrape_tasks/instructions/instruction'
      :javascript
        [...document.querySelectorAll('#instruction .fr-view a')].forEach((el) => {
          el.setAttribute('target', '_black');
          el.setAttribute('rel', 'noopener noreferrer');
        })

  #scrapeEvaluationDoc.tab-pane.fade.show
    .card.border-top-0.rounded-top-0.mb-5
      #evaluationDocEdit.small
        .row
          .col-8.offset-2.p-0
            %hr.mb-0.mt-3/
            .d-inline-block
              =button_to('[ edit ]', edit_scrape_task_evaluation_doc_path(@scrape_task), class: 'btn btn-sm btn-link', method: :get, remote: true, data: { disable_with: '...'})
            -if !@scrape_task.evaluation
              .d-inline-block
                =button_to('[ evaluate ]', scrape_task_evaluate_path(@scrape_task), method: :patch, remote: true,
                            id: 'evaluateButton', class: 'btn btn-sm btn-link ml-1', data: { disable_with: '...'})
            %hr.mt-0/
      #evaluationDoc.show{ "data-parent" => "#scrapeEvaluationDoc" }
        =render 'scrape_tasks/evaluation_docs/evaluation_doc'
      :javascript
        [...document.querySelectorAll('#evaluationDoc .fr-view a')].forEach((el) => {
          el.setAttribute('target', '_black');
          el.setAttribute('rel', 'noopener noreferrer');
        })
