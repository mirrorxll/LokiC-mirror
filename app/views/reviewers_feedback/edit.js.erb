(()=>{
    let human_feedback_modal = $('#human_feedback_modal')
    human_feedback_modal.modal('show')
    human_feedback_modal.on('hidden.bs.modal', function (e) { stopReviewersFeedbackSaver(); })

    let fcd_body = document.getElementById('fcd_body').innerHTML;

    document.getElementById('human_feedback_modal_label').innerText = `<%= "FCD ##{@story_type.id} #{@story_type.name} -- #{@story_type.developer.name} -- reviewers feedback".html_safe %>`
    document.querySelector('#human_feedback_modal #fcd').innerHTML = fcd_body;
    document.querySelector('#human_feedback_modal .w-39').innerHTML = `<%= j render 'form' %>`

    let samples =
        <% if Rails.env.production? %>
          document.querySelectorAll('#human_feedback_modal #fcd a[href^="https://lokic.locallabs.com/story_types/"][href*="/iterations/"][href*="/samples/"]')
        <% else %>
          document.querySelectorAll('#human_feedback_modal #fcd a[href^="http://localhost:3000/story_types/"][href*="/iterations/"][href*="/samples/"]')
        <% end %>

    samples.forEach(function(a) {
       a.removeAttribute('target');
       a.setAttribute('data-remote', 'true')
    });

    let feedbackEditor = $('#reviewers_feedback_editable [data-editor="summernote"]')
    feedbackEditor.summernote({
        height: 300,
        toolbar: [
            ['style', ['style']],
            ['font', ['clear' , 'bold', 'italic', 'underline', 'strikethrough']],
            ['fontname', ['fontname', 'fontsize']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['table', ['table']],
            ['insert', ['link', 'picture', 'video']],
            ['view', ['fullscreen', 'codeview', 'help']],
        ]
    });

    let editorFeedback = document.getElementById('reviewers_feedback_body').innerHTML;

    if(editorFeedback)
        feedbackEditor.summernote('code', editorFeedback);

    sessionStorage['editorFeedbackSaverId'] = setInterval(reviewersFeedbackSaver, 30000);
}).call();

function reviewersFeedbackSaver() {
    let editorFeedbackStr = document.querySelector('#reviewers_feedback_editable .note-editable').innerHTML;

    $.ajax({
        url: '<%= save_story_type_fact_checking_doc_reviewers_feedback_url(@story_type, @fcd, @reviewers_feedback) %>',
        data: { reviewers_feedback: { body: editorFeedbackStr } },
        method: 'patch',
        dataType: 'script'
    });
}

function stopReviewersFeedbackSaver() {
    clearInterval(sessionStorage['editorFeedbackSaverId'])
    sessionStorage.removeItem('editorFeedbackSaverId')
}
