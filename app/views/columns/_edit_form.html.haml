=form_with(model: [@story_type, @staging_table, @staging_table.columns], method: :put) do |form|
  #add-column.mb-2.mt-4
    =icon('fas', 'plus')
  %div#columns-editable
    -@staging_table.columns.list.each do |hex, column|
      %div{ id: "col_#{hex}" }
        %div.remove_column.d-inline-block.mr-1{ id: "rm_col_#{hex}", onclick: 'removeColumn(this)' }
          =icon('fas', 'minus')
        =form.text_field "#{hex}[name]",
                         { value: column[:name], placeholder: 'name', id: "columns_#{hex}_name", required: true }
        =form.select "#{hex}[type]",options_for_select(data_types, column[:type]), {},
                     { id: "columns_#{hex}_type", onchange: 'optionsForColumnType(this)' }
        .d-inline-block
          -if column[:type].eql?(:string)
            =form.text_field "#{hex}[opts[limit]]", { value: column[:opts][:limit], placeholder: 'limit', id: "columns_#{hex}_opts_limit", required: true }
          -elsif column[:type].eql?(:decimal)
            =form.text_field "#{hex}[opts[precision]]", { value: column[:opts][:precision], placeholder: 'precision', id: "columns_#{hex}_opts_precision", required: true}
            =form.text_field "#{hex}[opts[scale]]", { value: column[:opts][:scale], placeholder: 'scale', id: "columns_#{hex}_opts_scale", required: true }
  =form.submit :update, class: 'mt-3 ml-3'

:javascript
  var editable_block = $('#columns-editable');
  $('#add-column').click(function () {
    let hex = secureRandom(6);

    $(editable_block).append(
        `<div id="col_${hex}">
            <div class="remove_column d-inline-block mr-1" id="rm_col_${hex}" onclick="removeColumn(this)"><i class="fas fa-minus"></i></div>
            <input placeholder="name" id="columns_${hex}_name" required="required" type="text" name="columns[${hex}[name]]">
            <select id="columns_${hex}_type" onchange="optionsForColumnType(this)" name="columns[${hex}[type]]">
                <option value="integer">integer</option>
                <option value="float">float</option>
                <option value="decimal">decimal</option>
                <option value="date">date</option>
                <option value="time">time</option>
                <option value="datetime">datetime</option>
                <option value="string">string</option>
                <option value="text">text</option>
                <option value="boolean">boolean</option>
            </select>
        </div>`
    );
  });

  function secureRandom(n){
    let result = '';
    while (n--){
      result += Math.floor(Math.random()*16).toString(16);
    }

    return result;
  }

  function removeColumn(elem) {
    $(elem.parentNode).remove();
  }

  function optionsForColumnType(elem) {
    let parent = elem.parentNode;
    let hex = parent.id.split('_')[1]
    while (parent.childElementCount > 3)
      $(elem).next().remove();

    switch (elem.options[elem.selectedIndex].value) {
      case 'decimal':
        $(parent).append(`
          <input placeholder="precision" type="text"
            name="columns[${hex}[opts[precision]]]" id="columns_${hex}_opts_precision">
          <input placeholder="scale" type="text"
            name="columns[${hex}[opts[scale]]]" id="columns_${hex}_opts_scale">`);
        break;
      case 'string':
        $(parent).append(`
          <input placeholder="limit" type="text"
            name="columns[${hex}[opts[limit]]]" id="columns_${hex}_opts_limit">
        `);
        break;
    }
  }
